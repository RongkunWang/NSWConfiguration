## GitLab CI template for NSW DAQ build jobs

variables:
  BUILD_DIR: ${CI_BUILDS_DIR}/${GITLAB_USER_LOGIN}/ci-build

.build_setup: &build_setup |-
  source /cvmfs/atlas.cern.ch/repo/sw/tdaq/tools/cmake_tdaq/bin/cm_setup.sh ${TDAQ_RELEASE} ${COMPILER_PROFILE}

.cmake_prep: &cmake_prep |-
  mkdir -p ${BUILD_DIR}
  pushd ${BUILD_DIR}
  ln -sf ../${CI_PROJECT_NAME} .
  export TDAQ_VERSION=$(echo $TDAQ_RELEASE | awk '{split($$0,a,"-"); printf("%d.%d.%d",a[2],a[3],a[4]);}')
  cat <<'EOF'> CMakeLists.txt
  cmake_minimum_required(VERSION 3.14.0)

  set(TDAQ_VERSION 8.3.1 CACHE STRING "TDAQ version number")
  set(NSWDAQ_VERSION 1.0.0 CACHE STRING "NSWDAQ version number")

  message(STATUS "TDAQ_VERSION [${TDAQ_VERSION}]")
  message(STATUS "NSWDAQ_VERSION [${NSWDAQ_VERSION}]")

  project(nswdaq-ci-build VERSION ${NSWDAQ_VERSION})

  find_package(TDAQ)
  include(CTest)

  tdaq_project(nswdaq-ci-build ${NSWDAQ_VERSION} USES tdaq ${TDAQ_VERSION})
  EOF


# Base template for all build jobs
.build:
  image: gitlab-registry.cern.ch/atlas-tdaq-software/tdaq_ci:centos7
  tags:
    - cvmfs
  stage: build
  before_script:
    - echo 'Build job ${CI_JOB_NAME} started'
    - *build_setup
    - *cmake_prep
  script:
    - cmake -B${CMTCONFIG} -DTDAQ_VERSION=${TDAQ_VERSION} -S.
    - cmake --build ${CMTCONFIG} --verbose -- ${MAKE_OPTIONS}
    - pwd; ls -l
  after_script:
    - ls -l
    - echo 'Build job ${CI_JOB_NAME} finished'

#
# Build jobs
#

## Current stable TDAQ release
build:stable:
  rules:
    - if: '$CI_COMMIT_BRANCH !~ "^dev$"'
  extends: .build
  allow_failure: false

## Current stable builds on the dev branch
build:stable:dev:
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
  extends: .build
  variables:
    MAKE_OPTIONS: "-j1"
  allow_failure: false

## Current stable release, gcc10 compiler profile
build:stable:gcc10:
  extends: build:stable
  # rules:
  #   - if: '$CI_COMMIT_BRANCH == "master"' ## only on branch 'master'
  #   - if: $CI_COMMIT_TAG                  ## only on tags
  variables:
    COMPILER_PROFILE: x86_64-centos7-gcc10-opt
  # parallel:
  #   matrix: ## requires 13.3..., CERN is on 13.1
  #     - TDAQ_RELEASE: tdaq-09-01-00
  #     - TDAQ_RELEASE: tdaq-99-00-00
  allow_failure: true

## Unstable TDAQ releases, allowed to fail
build:tdaq-08-03-01:
  extends: build:stable
  variables:
    TDAQ_RELEASE: tdaq-08-03-01
  allow_failure: true

build:tdaq-09-01-00:
  extends: build:stable
  variables:
    TDAQ_RELEASE: tdaq-09-01-00
  allow_failure: true

## Nightly TDAQ releases, allowed to fail
build:nightly:
  rules:
    - when: manual
  extends: build:stable
  variables:
    TDAQ_RELEASE: tdaq-99-00-00
  allow_failure: true
